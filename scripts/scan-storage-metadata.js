/**
 * Supabase Storage„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶markdown_files_metadata„ÉÜ„Éº„Éñ„É´„Å´ÊäïÂÖ•
 * 
 * ‰ΩøÁî®ÊñπÊ≥ï:
 * node scripts/scan-storage-metadata.js [limit]
 */

require('dotenv').config({ path: '.env.local' });
const { createClient } = require('@supabase/supabase-js');

// SupabaseË®≠ÂÆö
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://wpwqxhyiglbtlaimrjrx.supabase.co';
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

if (!SUPABASE_SERVICE_KEY) {
  console.error('‚ùå SUPABASE_SERVICE_ROLE_KEYÁí∞Â¢ÉÂ§âÊï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
const LIMIT = parseInt(process.argv[2]) || 1000; // „Éá„Éï„Ç©„É´„Éà1000„Éï„Ç°„Ç§„É´

console.log(`üîç Storage „Çπ„Ç≠„É£„É≥ÈñãÂßã (ÊúÄÂ§ß${LIMIT}„Éï„Ç°„Ç§„É´)`);
console.log(`üì° Êé•Á∂öÂÖà: ${SUPABASE_URL}`);

// „É≠„Ç∞Âá∫ÂäõÁî®„ÅÆËâ≤‰ªò„Åë
const log = {
  info: (msg) => console.log('\\x1b[36m%s\\x1b[0m', `‚Ñπ ${msg}`),
  success: (msg) => console.log('\\x1b[32m%s\\x1b[0m', `‚úì ${msg}`),
  error: (msg) => console.log('\\x1b[31m%s\\x1b[0m', `‚úó ${msg}`),
  warning: (msg) => console.log('\\x1b[33m%s\\x1b[0m', `‚ö† ${msg}`)
};

// „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÇíËß£Êûê„Åô„ÇãÈñ¢Êï∞
function parseFilePath(filePath) {
  const parts = filePath.split('/');
  const fileName = parts[parts.length - 1];
  
  // ‰ºÅÊ•≠ID„ÇíÊäΩÂá∫
  const companyId = parts[0];
  
  // „Éâ„Ç≠„É•„É°„É≥„Éà„Ç´„ÉÜ„Ç¥„É™„ÇíÊäΩÂá∫
  let documentType = 'unknown';
  for (const part of parts) {
    if (part.includes('PublicDoc')) {
      documentType = 'PublicDoc';
      break;
    } else if (part.includes('AuditDoc')) {
      documentType = 'AuditDoc';
      break;
    }
  }
  
  // „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éó„ÇíÊäΩÂá∫
  let sectionType = 'unknown';
  if (fileName.startsWith('0000000_header')) {
    sectionType = 'header';
  } else if (fileName.startsWith('0101010_honbun')) {
    sectionType = 'company_overview';
  } else if (fileName.startsWith('0102010_honbun')) {
    sectionType = 'business_overview';
  } else if (fileName.startsWith('0103010_honbun')) {
    sectionType = 'business_risks';
  } else if (fileName.startsWith('0104010_honbun')) {
    sectionType = 'management_analysis';
  } else if (fileName.startsWith('0105000_honbun')) {
    sectionType = 'financial_statements';
  } else if (fileName.includes('_honbun_')) {
    sectionType = 'main_content';
  } else if (fileName.includes('_cover_')) {
    sectionType = 'cover';
  } else {
    sectionType = 'other';
  }
  
  // „Éï„Ç°„Ç§„É´È†ÜÂ∫è„ÇíÊäΩÂá∫
  const orderMatch = fileName.match(/^([0-9]+)/);
  const fileOrder = orderMatch ? parseInt(orderMatch[1]) : 9999;
  
  // Âπ¥Â∫¶„ÇíÊäΩÂá∫Ôºà„Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÔºâ
  const yearMatch = fileName.match(/(202[0-9])/);
  const fiscalYear = yearMatch ? parseInt(yearMatch[1]) : null;
  
  return {
    companyId,
    fileName,
    documentType,
    sectionType,
    fileOrder,
    fiscalYear,
    storagePath: `markdown-files/${filePath}`,
    filePath
  };
}

// Storage„Åã„ÇâÂÖ®„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∏∞ÁöÑ„Å´ÂèñÂæó
async function getAllStorageFiles(prefix = '', allFiles = []) {
  try {
    log.info(`üìÇ „Çπ„Ç≠„É£„É≥‰∏≠: ${prefix || 'root'}`);
    
    const { data: files, error } = await supabase.storage
      .from('markdown-files')
      .list(prefix, {
        limit: 1000,
        sortBy: { column: 'name', order: 'asc' }
      });
    
    if (error) {
      log.error(`Storage list error: ${error.message}`);
      return allFiles;
    }
    
    if (!files || files.length === 0) {
      return allFiles;
    }
    
    for (const file of files) {
      const fullPath = prefix ? `${prefix}/${file.name}` : file.name;
      
      // „Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂ†¥Âêà„ÅØÂÜçÂ∏∞ÁöÑ„Å´Êé¢Á¥¢
      if (!file.metadata || file.metadata.size === undefined || file.metadata.size === null) {
        await getAllStorageFiles(fullPath, allFiles);
      } 
      // Markdown„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÅØ„É™„Çπ„Éà„Å´ËøΩÂä†
      else if (file.name.endsWith('.md')) {
        allFiles.push({
          path: fullPath,
          name: file.name,
          size: file.metadata.size || 0,
          lastModified: file.updated_at || file.created_at || new Date().toISOString()
        });
        
        // Âà∂Èôê„Å´ÈÅî„Åó„Åü„ÇâÂÅúÊ≠¢
        if (allFiles.length >= LIMIT) {
          log.warning(`Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü: ${LIMIT}„Éï„Ç°„Ç§„É´`);
          break;
        }
      }
    }
    
    return allFiles;
  } catch (error) {
    log.error(`„Éï„Ç°„Ç§„É´ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
    return allFiles;
  }
}

// „Éï„Ç°„Ç§„É´„ÅÆÊúÄÂàù„ÅÆÈÉ®ÂàÜ„ÇíÂèñÂæó„Åó„Å¶„Éó„É¨„Éì„É•„Éº„Çí‰ΩúÊàê
async function getContentPreview(filePath) {
  try {
    const { data, error } = await supabase.storage
      .from('markdown-files')
      .download(filePath);
    
    if (error) {
      log.warning(`„Éó„É¨„Éì„É•„ÉºÂèñÂæóÂ§±Êïó: ${filePath} - ${error.message}`);
      return null;
    }
    
    const content = await data.text();
    
    // ÊúÄÂàù„ÅÆ500ÊñáÂ≠ó„ÇíÂèñÂæó
    const preview = content.substring(0, 500);
    
    // „ÉÜ„Éº„Éñ„É´„Å®ÁîªÂÉè„ÅÆÂ≠òÂú®„ÇíÁ¢∫Ë™ç
    const hasTables = content.includes('|') && content.includes('---');
    const hasImages = /!\\[.*\\]\\(.*\\.(jpg|jpeg|png|gif|svg)\\)/i.test(content);
    
    return {
      preview,
      hasTables,
      hasImages
    };
  } catch (error) {
    log.warning(`„Éó„É¨„Éì„É•„ÉºÂá¶ÁêÜ„Ç®„É©„Éº: ${filePath} - ${error.message}`);
    return null;
  }
}

// ‰ºÅÊ•≠Âêç„ÇíÂèñÂæó
async function getCompanyName(companyId) {
  try {
    const { data, error } = await supabase
      .from('companies')
      .select('name')
      .eq('id', companyId)
      .single();
    
    if (error || !data) {
      return null;
    }
    
    return data.name;
  } catch (error) {
    return null;
  }
}

// „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„É°„Çø„Éá„Éº„Çø„ÇíÊåøÂÖ•
async function insertMetadata(fileInfo, contentData) {
  try {
    const record = {
      company_id: fileInfo.companyId,
      company_name: await getCompanyName(fileInfo.companyId),
      file_name: fileInfo.fileName,
      file_path: fileInfo.filePath,
      storage_path: fileInfo.storagePath,
      fiscal_year: fileInfo.fiscalYear,
      document_type: fileInfo.documentType,
      section_type: fileInfo.sectionType,
      file_order: fileInfo.fileOrder,
      file_size: fileInfo.size,
      file_extension: 'md',
      content_preview: contentData?.preview || '',
      has_tables: contentData?.hasTables || false,
      has_images: contentData?.hasImages || false,
      storage_bucket: 'markdown-files',
      indexed_at: new Date().toISOString()
    };
    
    const { error } = await supabase
      .from('markdown_files_metadata')
      .upsert(record, {
        onConflict: 'file_path',
        ignoreDuplicates: false
      });
    
    if (error) {
      log.error(`„É°„Çø„Éá„Éº„ÇøÊåøÂÖ•„Ç®„É©„Éº: ${fileInfo.fileName} - ${error.message}`);
      return false;
    }
    
    return true;
  } catch (error) {
    log.error(`„É°„Çø„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº: ${fileInfo.fileName} - ${error.message}`);
    return false;
  }
}

// „É°„Ç§„É≥Âá¶ÁêÜ
async function main() {
  console.log('========================================');
  console.log('üìÅ Storage „É°„Çø„Éá„Éº„Çø„Çπ„Ç≠„É£„É≥ÈñãÂßã');
  console.log('========================================\\n');
  
  try {
    // 1. „Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
    log.info('Storage„Åã„Çâ„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠...');
    const allFiles = await getAllStorageFiles();
    
    log.success(`ÂêàË®à ${allFiles.length} ÂÄã„ÅÆMarkdown„Éï„Ç°„Ç§„É´„ÇíÊ§úÂá∫`);
    
    if (allFiles.length === 0) {
      log.warning('Âá¶ÁêÜÂØæË±°„ÅÆ„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      return;
    }
    
    // „Çµ„É≥„Éó„É´Ë°®Á§∫
    console.log('\\nüìÑ Ê§úÂá∫„Åï„Çå„Åü„Éï„Ç°„Ç§„É´‰æã:');
    allFiles.slice(0, 3).forEach(file => {
      console.log(`  - ${file.path} (${(file.size / 1024).toFixed(1)}KB)`);
    });
    
    // 2. „É°„Çø„Éá„Éº„Çø„ÇíÂá¶ÁêÜ
    let processedCount = 0;
    let errorCount = 0;
    
    for (let i = 0; i < allFiles.length; i++) {
      const file = allFiles[i];
      const progress = `[${i + 1}/${allFiles.length}]`;
      
      if (i % 10 === 0) {
        console.log(`\\n${progress} Âá¶ÁêÜ‰∏≠: ${file.path}`);
      }
      
      // „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÇíËß£Êûê
      const fileInfo = {
        ...parseFilePath(file.path),
        size: file.size,
        lastModified: file.lastModified
      };
      
      // ÂÜÖÂÆπ„ÅÆ„Éó„É¨„Éì„É•„Éº„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆ50„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÔºâ
      let contentData = null;
      if (i < 50) {
        contentData = await getContentPreview(file.path);
      }
      
      // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÊåøÂÖ•
      const success = await insertMetadata(fileInfo, contentData);
      
      if (success) {
        processedCount++;
        if (i % 10 === 0) {
          log.success(`  ‚úì ${fileInfo.companyId} - ${fileInfo.sectionType}`);
        }
      } else {
        errorCount++;
      }
      
      // ÈÄ≤ÊçóË°®Á§∫
      if ((i + 1) % 50 === 0) {
        log.info(`ÈÄ≤Êçó: ${i + 1}/${allFiles.length} (${Math.round((i + 1) / allFiles.length * 100)}%)`);
      }
    }
    
    // 3. ÁµêÊûúË°®Á§∫
    console.log('\\n========================================');
    console.log('üìä „Çπ„Ç≠„É£„É≥ÂÆå‰∫Ü');
    console.log('========================================');
    log.success(`Âá¶ÁêÜÊ∏à„Åø: ${processedCount} „Éï„Ç°„Ç§„É´`);
    if (errorCount > 0) {
      log.error(`„Ç®„É©„Éº: ${errorCount} „Éï„Ç°„Ç§„É´`);
    }
    
    // 4. Áµ±Ë®àÊÉÖÂ†±
    const { count } = await supabase
      .from('markdown_files_metadata')
      .select('*', { count: 'exact', head: true });
    
    log.info(`„É°„Çø„Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´Á∑è„É¨„Ç≥„Éº„ÉâÊï∞: ${count}`);
    
    // ‰ºÅÊ•≠Âà•Áµ±Ë®à
    const { data: companyStats } = await supabase
      .from('markdown_files_summary')
      .select('company_id, company_name, document_type, file_count')
      .limit(10);
    
    if (companyStats && companyStats.length > 0) {
      console.log('\\nüìà ‰ºÅÊ•≠Âà•Áµ±Ë®àÔºà‰∏ä‰Ωç10Á§æÔºâ:');
      companyStats.forEach(stat => {
        console.log(`  - ${stat.company_name || stat.company_id}: ${stat.file_count}„Éï„Ç°„Ç§„É´ (${stat.document_type})`);
      });
    }
    
  } catch (error) {
    log.error(`Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
    console.error(error);
    process.exit(1);
  }
}

// „Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å
if (require.main === module) {
  main().catch(error => {
    log.error(`ÂÆüË°å„Ç®„É©„Éº: ${error.message}`);
    console.error(error);
    process.exit(1);
  });
}

module.exports = { main, parseFilePath, getContentPreview };