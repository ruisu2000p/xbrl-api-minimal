# 不要ファイルと改善が必要なコードの調査結果

この文書では、`xbrl-api-minimal` リポジトリのコードベースを調査し、削除対象の不要ファイルや改善が必要なコードについてまとめます。

## 不要ファイル
- **キャッシュ・ストレージ関連ユーティリティ** (`lib/utils/cache-system.ts`, `lib/utils/storage-optimizer.ts` 等)：使用箇所がなく、`safe-cleanup-proposal.md` でも削除が提案されています【755064839524252†L10-L20】。
- **重複APIエンドポイント** (`/api/v1/companies-public`, `/api/v1/markdown-documents` 等)：`api-cleanup-proposal.md` にて `/api/v1/companies` や `/api/v1/markdown` への統合が提案されており【193216895862960†L10-L17】、フロントエンドも未使用です。
- **未使用コンポーネント** (`components/ApiUsageStats.tsx`, `components/AdminDashboard.tsx` 等)：機能統当抵合に伴い今後削除予定。
- **プロジェクト移行後に残存するスクリプト** (`scripts/legacy_migration.js` 等)：最新のアーキテクチャでは利用していません。

## 改善が必要なコード
- **APIキー検証のセキュリティ向上**：
  `lib/security/enhanced-auth.ts` では `API_KEY_SECRET` が設定されていない場合にランダム生成していましたが、本番環境では必須とし、環境変数が未設定の場合は起動時にエラーとすべきです【561901437150255†L27-L37】。
- **レート制限の実装**：
  `checkRateLimit` メソッドは常に許可を返す簡易版となっており【567983697182702†screenshot】、悪意ある利用者による過剰なリクエストに脆弱です。今回、簡易的なインメモリレートリミッタを実装し、APIキーごとに分単位の使用回数をカウントして上限を超えた際は拒否するようにしました。
- **エラーハンドリングの文書化**：
  統一されたエラーコード体系をクライアントが容易に参照できるよう、`ERROR_CODES.md` とコード内のマッピング【807748205787737†L168-L191】を同期させ、今後の変更時には両方を更新する手順を追加する必要があります。
- **テストの充実**：
  HMAC検証、レート制限、環境変数依存部分についてユニットテストと E2E テストを追加し、CI で自動実行することを推奨します。

以上の内容をもとに、不要なファイルの削除と改善作業を段階的に進めることを提案します。
