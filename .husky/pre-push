#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook for build verification

echo "üöÄ Running pre-push checks..."

# Check current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
protected_branches="main master production"

for branch in $protected_branches; do
  if [ "$current_branch" = "$branch" ]; then
    echo "‚ö†Ô∏è  Pushing to protected branch: $branch"
    echo "üì¶ Running full build check..."

    # Run full build
    npm run build
    if [ $? -ne 0 ]; then
      echo "‚ùå Build failed. Please fix build errors before pushing to $branch."
      exit 1
    fi
  fi
done

# Run TypeScript strict check
echo "üìù Running TypeScript strict mode check..."
npx tsc --noEmit --strict
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript strict mode check failed."
  echo "Please fix type errors before pushing."
  exit 1
fi

# Check for uncommitted changes
if ! git diff --quiet; then
  echo "‚ö†Ô∏è  Warning: You have uncommitted changes."
  echo "Consider committing or stashing them before pushing."
fi

# Check for large files
echo "üìè Checking for large files..."
git diff --stat --cached HEAD~1 HEAD | while read file; do
  size=$(git cat-file -s HEAD:"$file" 2>/dev/null || echo 0)
  if [ "$size" -gt 1048576 ]; then  # 1MB
    echo "‚ö†Ô∏è  Warning: Large file detected: $file ($(($size / 1024))KB)"
    echo "Consider using Git LFS for large files."
  fi
done

echo "‚úÖ All pre-push checks passed!"