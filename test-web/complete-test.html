<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XBRL API ÂÆåÂÖ®„ÉÜ„Çπ„Éà - „Éá„Éº„ÇøÔºÜ„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„ÇØ„Çª„Çπ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #764ba2;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: #764ba2;
        }

        .tab.active {
            color: #764ba2;
            border-bottom-color: #764ba2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        input, select, textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 100%;
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            line-height: 1.5;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .document-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .document-title {
            font-weight: 600;
            color: #333;
        }

        .document-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-buttons button {
            padding: 8px 16px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #764ba2;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .endpoint-list {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .endpoint-item:last-child {
            border-bottom: none;
        }

        .method-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 10px;
            width: 50px;
            text-align: center;
        }

        .method-badge.post {
            background: #007bff;
        }

        .endpoint-path {
            flex: 1;
            font-family: monospace;
            font-size: 13px;
        }

        .test-btn {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üî¨ XBRL API ÂÆåÂÖ®„ÉÜ„Çπ„Éà„Çπ„Ç§„Éº„Éà
            <span id="connectionStatus" class="status-badge status-warning">Êú™Êé•Á∂ö</span>
        </h1>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('metadata')">üìä „É°„Çø„Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ</button>
            <button class="tab" onclick="switchTab('storage')">üíæ „Çπ„Éà„É¨„Éº„Ç∏„Ç¢„ÇØ„Çª„Çπ</button>
            <button class="tab" onclick="switchTab('apikey')">üîë API„Ç≠„ÉºÁÆ°ÁêÜ</button>
            <button class="tab" onclick="switchTab('endpoints')">üöÄ „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà‰∏ÄË¶ß</button>
        </div>

        <!-- APIË®≠ÂÆöÔºàÂÖ±ÈÄöÔºâ -->
        <div style="margin-bottom: 30px;">
            <h2>‚öôÔ∏è APIÊé•Á∂öË®≠ÂÆö</h2>
            <div style="display: grid; grid-template-columns: 3fr 2fr 1fr; gap: 15px;">
                <div class="form-group" style="margin: 0;">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:3001/functions/v1" />
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>API„Ç≠„Éº</label>
                    <input type="text" id="apiKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwd3F4aHlpZ2xidGxhaW1yanJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTk1NDEsImV4cCI6MjA3Mzc5NTU0MX0.aGMCRtTRIbdUMRTdJ7KFZ7oJ2krkD7QWzUEcTs7Jlfs" placeholder="Anon Key „Åæ„Åü„ÅØ xbrl_v1_..." />
                </div>
                <div class="form-group" style="margin: 0; align-self: flex-end;">
                    <button onclick="testConnection()">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
                </div>
            </div>
            <div id="connectionResult"></div>
        </div>

        <!-- „É°„Çø„Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ„Çø„Éñ -->
        <div id="metadata-tab" class="tab-content active">
            <h2>üìä markdown_files_metadata „ÉÜ„Éº„Éñ„É´„Ç¢„ÇØ„Çª„Çπ„ÉÜ„Çπ„Éà</h2>

            <div class="form-group">
                <label>‰ºÅÊ•≠Âêç/„Ç≥„Éº„ÉâÔºàÈÉ®ÂàÜ‰∏ÄËá¥Ôºâ</label>
                <input type="text" id="searchCompany" placeholder="‰æã: „Éà„É®„Çø„ÄÅ‰∏âËè±„ÄÅS100..." />
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Âπ¥Â∫¶</label>
                    <select id="searchFiscalYear">
                        <option value="">ÂÖ®Âπ¥Â∫¶</option>
                        <option value="FY2025">FY2025</option>
                        <option value="FY2024">FY2024</option>
                        <option value="FY2023">FY2023</option>
                        <option value="FY2022">FY2022</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÊñáÊõ∏„Çø„Ç§„Éó</label>
                    <select id="searchDocType">
                        <option value="all">„Åô„Åπ„Å¶</option>
                        <option value="PublicDoc">Êúâ‰æ°Ë®ºÂà∏Â†±ÂëäÊõ∏</option>
                        <option value="AuditDoc">Áõ£ÊüªÂ†±ÂëäÊõ∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÂèñÂæó‰ª∂Êï∞</label>
                    <select id="searchLimit">
                        <option value="10">10‰ª∂</option>
                        <option value="20">20‰ª∂</option>
                        <option value="50">50‰ª∂</option>
                        <option value="100">100‰ª∂</option>
                    </select>
                </div>
            </div>

            <button onclick="searchDocuments()">üîç Ê§úÁ¥¢ÂÆüË°å</button>

            <div id="searchResult"></div>
            <div id="documentsList"></div>
        </div>

        <!-- „Çπ„Éà„É¨„Éº„Ç∏„Ç¢„ÇØ„Çª„Çπ„Çø„Éñ -->
        <div id="storage-tab" class="tab-content">
            <h2>üíæ Supabase Storage „Ç¢„ÇØ„Çª„Çπ„ÉÜ„Çπ„Éà</h2>

            <div class="form-group">
                <label>„Çπ„Éà„É¨„Éº„Ç∏„Éë„ÇπÔºàmarkdown_files_metadata„Åã„ÇâÂèñÂæóÔºâ</label>
                <input type="text" id="storagePath" placeholder="‰æã: FY2025/S100TT6U_b3dba3fcf6e4e494/PublicDoc_markdown/..." />
                <small style="color: #666; display: block; margin-top: 5px;">
                    ‚Äª ‰∏äË®ò„É°„Çø„Éá„Éº„ÇøÊ§úÁ¥¢„Åã„Çâ„Äå„Çπ„Éà„É¨„Éº„Ç∏ÂèñÂæó„Äç„Éú„Çø„É≥„Åß„Éë„Çπ„ÇíËá™ÂãïÂÖ•Âäõ„Åß„Åç„Åæ„Åô
                </small>
            </div>

            <div class="form-group">
                <label>ÊúÄÂ§ß„Çµ„Ç§„Ç∫Ôºà„Éê„Ç§„ÉàÔºâ</label>
                <input type="number" id="maxSize" value="100000" />
            </div>

            <button onclick="getDocument()">üì• „Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæó</button>

            <div id="storageResult"></div>
            <div id="documentContent"></div>
        </div>

        <!-- API„Ç≠„ÉºÁÆ°ÁêÜ„Çø„Éñ -->
        <div id="apikey-tab" class="tab-content">
            <h2>üîë Áã¨Ëá™API„Ç≠„Éº„ÉÜ„Çπ„Éà</h2>

            <div class="form-group">
                <label>Êñ∞Ë¶èAPI„Ç≠„ÉºÁîüÊàêÔºà„Éá„É¢Ôºâ</label>
                <button onclick="generateNewKey()">Êñ∞Ë¶è„Ç≠„ÉºÁîüÊàê</button>
            </div>

            <div id="generatedKey"></div>

            <div class="form-group" style="margin-top: 30px;">
                <label>API„Ç≠„ÉºÊ§úË®º</label>
                <input type="text" id="validateKey" placeholder="Ê§úË®º„Åô„ÇãAPI„Ç≠„Éº„ÇíÂÖ•Âäõ" />
                <button onclick="validateApiKey()">Ê§úË®ºÂÆüË°å</button>
            </div>

            <div id="validationResult"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Á∑è„Éâ„Ç≠„É•„É°„É≥„ÉàÊï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCompanies">0</div>
                    <div class="stat-label">‰ºÅÊ•≠Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statYears">0</div>
                    <div class="stat-label">Âπ¥Â∫¶Êï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAccess">Free</div>
                    <div class="stat-label">„Ç¢„ÇØ„Çª„Çπ„ÉÜ„Ç£„Ç¢</div>
                </div>
            </div>
        </div>

        <!-- „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà‰∏ÄË¶ß„Çø„Éñ -->
        <div id="endpoints-tab" class="tab-content">
            <h2>üöÄ Âà©Áî®ÂèØËÉΩ„Å™API„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà</h2>

            <div class="endpoint-list">
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/health</span>
                    <button class="test-btn" onclick="testEndpoint('/api/health')">„ÉÜ„Çπ„Éà</button>
                </div>
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/search</span>
                    <button class="test-btn" onclick="testEndpoint('/api/search?limit=5')">„ÉÜ„Çπ„Éà</button>
                </div>
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/companies</span>
                    <button class="test-btn" onclick="testEndpoint('/api/companies?limit=5')">„ÉÜ„Çπ„Éà</button>
                </div>
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/company/:id</span>
                    <button class="test-btn" onclick="testCompanyEndpoint()">„ÉÜ„Çπ„Éà</button>
                </div>
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/document</span>
                    <button class="test-btn" onclick="testDocumentEndpoint()">„ÉÜ„Çπ„Éà</button>
                </div>
                <div class="endpoint-item">
                    <span class="method-badge">GET</span>
                    <span class="endpoint-path">/api/statistics</span>
                    <button class="test-btn" onclick="testEndpoint('/api/statistics')">„ÉÜ„Çπ„Éà</button>
                </div>
            </div>

            <div id="endpointResult"></div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentApiKey = 'demo-key';
        let currentDocuments = [];

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName) {
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Êé•Á∂ö„ÉÜ„Çπ„Éà
        async function testConnection() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            currentApiKey = apiKey;

            try {
                // api-proxy„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Åß„ÉÜ„Çπ„Éà
                const response = await fetch(`${apiUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'X-Api-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                if (response.ok) {
                    const text = await response.text();
                    document.getElementById('connectionStatus').className = 'status-badge status-success';
                    document.getElementById('connectionStatus').textContent = 'Êé•Á∂öÊ∏à„Åø';

                    showMessage('connectionResult',
                        `‚úÖ Êé•Á∂öÊàêÂäü: ${text === 'ok' ? 'Health check passed' : text} (${apiKey.startsWith('xbrl_v1_') ? 'Áã¨Ëá™API„Ç≠„Éº' : 'Anon Key'}‰ΩøÁî®)`, 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                document.getElementById('connectionStatus').className = 'status-badge status-error';
                document.getElementById('connectionStatus').textContent = '„Ç®„É©„Éº';

                // CORS„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅÆËøΩÂä†„É°„ÉÉ„Çª„Éº„Ç∏
                const errorMsg = error.message === 'Failed to fetch'
                    ? 'CORS„Éó„É≠„Ç≠„Ç∑„ÅåÂøúÁ≠î„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇhttp://localhost:3001 „ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    : error.message;

                showMessage('connectionResult',
                    `‚ùå „Ç®„É©„Éº: ${errorMsg}`, 'error');
            }
        }

        // „Éâ„Ç≠„É•„É°„É≥„ÉàÊ§úÁ¥¢
        async function searchDocuments() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const company = document.getElementById('searchCompany').value;
            const fiscalYear = document.getElementById('searchFiscalYear').value;
            const docType = document.getElementById('searchDocType').value;
            const limit = document.getElementById('searchLimit').value;

            showLoading('searchResult');

            const params = new URLSearchParams();
            if (company) params.append('company_name', company);
            if (fiscalYear && fiscalYear !== 'all') params.append('fiscal_year', fiscalYear);
            if (docType !== 'all') {
                const fileTypeMap = {
                    'Êúâ‰æ°Ë®ºÂà∏Â†±ÂëäÊõ∏': 'PublicDoc',
                    'Áõ£ÊüªÂ†±ÂëäÊõ∏': 'AuditDoc'
                };
                params.append('file_type', fileTypeMap[docType] || docType);
            }
            params.append('limit', limit);

            try {
                const response = await fetch(`${apiUrl}/markdown-files?${params}`, {
                    method: 'GET',
                    headers: {
                        'X-Api-Key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                const data = await response.json();

                if (response.ok) {
                    currentDocuments = data.data || [];
                    const tierInfo = data.tier ? ` (${data.tier} tier)` : '';

                    showMessage('searchResult',
                        `‚úÖ ${currentDocuments.length}‰ª∂„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü${tierInfo}`,
                        'success');

                    displayDocuments(currentDocuments);
                } else {
                    throw new Error(data.error || 'Ê§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                const errorMsg = error.message === 'Failed to fetch'
                    ? 'CORS„Éó„É≠„Ç≠„Ç∑„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ'
                    : error.message;
                showMessage('searchResult', `‚ùå „Ç®„É©„Éº: ${errorMsg}`, 'error');
                document.getElementById('documentsList').innerHTML = '';
            }
        }

        // „Éâ„Ç≠„É•„É°„É≥„Éà‰∏ÄË¶ßË°®Á§∫
        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');

            if (documents.length === 0) {
                container.innerHTML = '<div class="message info">„Éâ„Ç≠„É•„É°„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
                return;
            }

            container.innerHTML = '<div class="result-box">' +
                documents.map((doc, index) => `
                    <div class="document-item">
                        <div class="document-header">
                            <div>
                                <div class="document-title">${doc.company_name || 'Unknown'}</div>
                                <div class="document-meta">
                                    ID: ${doc.company_id} |
                                    Âπ¥Â∫¶: ${doc.fiscal_year} |
                                    „Çø„Ç§„Éó: ${doc.file_type}
                                </div>
                            </div>
                        </div>
                        <div class="document-meta">
                            „Éë„Çπ: <code>${doc.storage_path}</code>
                        </div>
                        <div class="action-buttons">
                            <button onclick="useStoragePath('${doc.storage_path}')">
                                üíæ „Çπ„Éà„É¨„Éº„Ç∏ÂèñÂæó
                            </button>
                            <button onclick="showDocumentDetails(${index})">
                                üìã Ë©≥Á¥∞Ë°®Á§∫
                            </button>
                        </div>
                    </div>
                `).join('') + '</div>';
        }

        // „Çπ„Éà„É¨„Éº„Ç∏„Éë„Çπ„Çí‰ΩøÁî®
        function useStoragePath(path) {
            document.getElementById('storagePath').value = path;
            switchTab('storage');
            document.querySelectorAll('.tab')[1].click(); // „Çπ„Éà„É¨„Éº„Ç∏„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
        }

        // „Éâ„Ç≠„É•„É°„É≥„ÉàË©≥Á¥∞Ë°®Á§∫
        function showDocumentDetails(index) {
            const doc = currentDocuments[index];
            alert(JSON.stringify(doc, null, 2));
        }

        // „Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæóÔºà„Çπ„Éà„É¨„Éº„Ç∏Ôºâ
        async function getDocument() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const path = document.getElementById('storagePath').value;
            const maxSize = document.getElementById('maxSize').value;

            if (!path) {
                showMessage('storageResult', '‚ùå „Çπ„Éà„É¨„Éº„Ç∏„Éë„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            showLoading('storageResult');

            try {
                const params = new URLSearchParams({
                    path: path,
                    max_size: maxSize
                });

                const response = await fetch(`${apiUrl}/document?${params}`, {
                    headers: { 'x-api-key': apiKey }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('storageResult',
                        `‚úÖ „Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæóÊàêÂäüÔºà„Çµ„Ç§„Ç∫: ${data.size}„Éê„Ç§„ÉàÔºâ`,
                        'success');

                    // „É°„Çø„Éá„Éº„Çø„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
                    document.getElementById('documentContent').innerHTML = `
                        <div class="result-box">
                            <h3>üìÑ „É°„Çø„Éá„Éº„Çø</h3>
                            <pre>${JSON.stringify(data.metadata, null, 2)}</pre>

                            <h3 style="margin-top: 20px;">üìù „Ç≥„É≥„ÉÜ„É≥„ÉÑÔºàÂÖàÈ†≠${maxSize}„Éê„Ç§„ÉàÔºâ</h3>
                            <pre>${escapeHtml(data.content.substring(0, 1000))}${data.content.length > 1000 ? '\n\n... (ÁúÅÁï•)' : ''}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || '„Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                showMessage('storageResult', `‚ùå „Ç®„É©„Éº: ${error.message}`, 'error');
                document.getElementById('documentContent').innerHTML = '';
            }
        }

        // Êñ∞Ë¶èAPI„Ç≠„ÉºÁîüÊàêÔºàÂÆüÈöõ„Å´„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÁôªÈå≤Ôºâ
        async function generateNewKey() {
            const apiKey = `xbrl_v1_${generateRandomString(32)}`;
            const apiUrl = document.getElementById('apiUrl').value;

            // „Éá„É¢„É¢„Éº„Éâ„Åæ„Åü„ÅØÂÆüÈöõ„ÅÆÁôªÈå≤„ÇíÈÅ∏Êäû
            const mode = confirm('ÂÆüÈöõ„Å´„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü\n\nOK: ÂÆüÈöõ„Å´ÁôªÈå≤ÔºàService Role KeyÂøÖË¶ÅÔºâ\n„Ç≠„É£„É≥„Çª„É´: „Éá„É¢„É¢„Éº„ÉâÔºàË°®Á§∫„ÅÆ„ÅøÔºâ');

            if (mode) {
                const serviceKey = prompt('Service Role Key „ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàAPI„Ç≠„Éº‰ΩúÊàê„Å´ÂøÖË¶ÅÔºâ:');
                if (!serviceKey) {
                    document.getElementById('generatedKey').innerHTML = `
                        <div class="message warning">
                            <strong>‚ö†Ô∏è Service Role Key „ÅåÂøÖË¶Å„Åß„Åô</strong><br>
                            Áã¨Ëá™API„Ç≠„Éº„Çí‰ΩúÊàê„Åô„Çã„Å´„ÅØService RoleÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                        </div>
                    `;
                    return;
                }

                try {
                // Supabase RPCÁµåÁî±„ÅßAPI„Ç≠„Éº„ÇíÁôªÈå≤
                const supabaseUrl = 'https://wpwqxhyiglbtlaimrjrx.supabase.co';
                const response = await fetch(`${supabaseUrl}/rest/v1/rpc/create_api_key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`
                    },
                    body: JSON.stringify({
                        p_api_key: apiKey,
                        p_user_id: 'test-user-' + Date.now(),
                        p_tier: 'free',
                        p_rate_limit: 100
                    })
                });

                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    result = { error: 'Response parse error' };
                }

                if (response.ok) {
                    document.getElementById('generatedKey').innerHTML = `
                        <div class="message success">
                            <strong>üîë Êñ∞Ë¶èAPI„Ç≠„ÉºÔºàÁôªÈå≤Ê∏à„ÅøÔºâ</strong><br>
                            <code style="display: block; margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                                ${apiKey}
                            </code>
                            <button style="margin-top: 10px;" onclick="copyToClipboard('${apiKey}')">
                                üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                            </button>
                            <small style="display: block; margin-top: 10px;">
                                „Åì„ÅÆ„Ç≠„Éº„ÅØ„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÁôªÈå≤„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Åô„Åê„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ
                            </small>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                    document.getElementById('generatedKey').innerHTML = `
                        <div class="message error">
                            <strong>‚ùå „Ç®„É©„Éº</strong><br>
                            ${error.message}
                        </div>
                    `;
                }
            } else {
                // „Éá„É¢„É¢„Éº„ÉâÔºàË°®Á§∫„ÅÆ„ÅøÔºâ
                document.getElementById('generatedKey').innerHTML = `
                    <div class="message info">
                        <strong>üîë Êñ∞Ë¶èAPI„Ç≠„ÉºÔºà„Éá„É¢„É¢„Éº„ÉâÔºâ</strong><br>
                        <code style="display: block; margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                            ${apiKey}
                        </code>
                        <button style="margin-top: 10px;" onclick="copyToClipboard('${apiKey}')">
                            üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                        </button>
                        <small style="display: block; margin-top: 10px; color: #666;">
                            <strong>Ê≥®ÊÑè:</strong> „Åì„Çå„ÅØ„Éá„É¢Áî®„ÅÆ„Ç≠„Éº„Åß„Åô„ÄÇÂÆüÈöõ„Å´„ÅØ„Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br>
                            ÂÆüÈöõ„Å´‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅService Role Key„Çí‰ΩøÁî®„Åó„Å¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </small>
                    </div>
                `;
            }
        }

        // API„Ç≠„ÉºÊ§úË®º
        async function validateApiKey() {
            const apiUrl = document.getElementById('apiUrl').value;
            const testKey = document.getElementById('validateKey').value;

            if (!testKey) {
                showMessage('validationResult', '‚ùå API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            showLoading('validationResult');

            try {
                // „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
                const healthResponse = await fetch(`${apiUrl}/health`, {
                    headers: { 'x-api-key': testKey }
                });

                // „Éá„Éº„Çø„Ç¢„ÇØ„Çª„Çπ„ÉÜ„Çπ„Éà
                const searchResponse = await fetch(`${apiUrl}/search?limit=1`, {
                    headers: { 'x-api-key': testKey }
                });

                const searchData = await searchResponse.json();

                if (healthResponse.ok && searchResponse.ok) {
                    const tierInfo = testKey === 'demo-key' ?
                        'Free (FY2024-2025„ÅÆ„Åø)' :
                        'Premium (ÂÖ®Âπ¥Â∫¶„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ)';

                    document.getElementById('validationResult').innerHTML = `
                        <div class="message success">
                            <strong>‚úÖ API„Ç≠„ÉºÊúâÂäπ</strong><br>
                            „Ç≠„Éº: <code>${testKey.substring(0, 20)}...</code><br>
                            „ÉÜ„Ç£„Ç¢: ${tierInfo}<br>
                            „Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Éá„Éº„Çø: ${searchData.total}‰ª∂
                        </div>
                    `;
                } else {
                    throw new Error('API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô');
                }
            } catch (error) {
                showMessage('validationResult', `‚ùå Ê§úË®ºÂ§±Êïó: ${error.message}`, 'error');
            }
        }

        // „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
        async function testEndpoint(endpoint) {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            showLoading('endpointResult');

            try {
                const response = await fetch(`${apiUrl.replace('/api', '')}${endpoint}`, {
                    headers: { 'x-api-key': apiKey }
                });

                const data = await response.json();

                document.getElementById('endpointResult').innerHTML = `
                    <div class="result-box">
                        <h3>${endpoint}</h3>
                        <div class="status-badge ${response.ok ? 'status-success' : 'status-error'}">
                            Status: ${response.status}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                showMessage('endpointResult', `‚ùå „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // ‰ºÅÊ•≠Ë©≥Á¥∞„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
        async function testCompanyEndpoint() {
            const companyId = prompt('‰ºÅÊ•≠IDÔºà‰æã: S100TT6UÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (companyId) {
                testEndpoint(`/api/company/${companyId}`);
            }
        }

        // „Éâ„Ç≠„É•„É°„É≥„Éà„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
        async function testDocumentEndpoint() {
            const path = prompt('„Çπ„Éà„É¨„Éº„Ç∏„Éë„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (path) {
                testEndpoint(`/api/document?path=${encodeURIComponent(path)}&max_size=1000`);
            }
        }

        // Áµ±Ë®àÊÉÖÂ†±ÂèñÂæó
        async function fetchStatistics() {
            const apiUrl = document.getElementById('apiUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            try {
                const response = await fetch(`${apiUrl}/statistics`, {
                    headers: { 'x-api-key': apiKey }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('statTotal').textContent = data.total_documents || 0;
                    document.getElementById('statCompanies').textContent = data.total_companies || 0;
                    document.getElementById('statYears').textContent = Object.keys(data.documents_by_year || {}).length;
                    document.getElementById('statAccess').textContent = data.tier_info?.current_tier?.toUpperCase() || 'Free';
                }
            } catch (error) {
                console.error('Áµ±Ë®àÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function showMessage(elementId, message, type) {
            // XSSÂØæÁ≠ñ: textContent„Çí‰ΩøÁî®
            const element = document.getElementById(elementId);
            element.textContent = '';
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            element.appendChild(div);
        }

        function showLoading(elementId) {
            // XSSÂØæÁ≠ñ: textContent„Çí‰ΩøÁî®
            const element = document.getElementById(elementId);
            element.textContent = '';
            const div = document.createElement('div');
            div.className = 'loading';
            div.textContent = 'Âá¶ÁêÜ‰∏≠...';
            element.appendChild(div);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            }).catch(err => {
                console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
            });
        }

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            testConnection();
        });
    </script>
</body>
</html>